# 分层结构

## 请求处理层

主要负责

- 解析命令
- 拼装参数 和 返回值

## db 层

主要负责

- 选择 slot
- 不属于的返回 move

## slot

1. 给每个写操作分配一个 id
   - u64，每秒 1 亿次写操作，也能运行 5800 年
   - 这个 id 一定是连续的，不能是跳跃的
1. 发送给 请求转发层
1. 写加锁
   - 更新 key 的 id
   - 记录最后一次操作的 id
1. 根据写 id，发送给 expire 的 task

## expire 层

后台处理过期的 key

## 请求转发层

1. 写入请求缓存
   - 缓存 1M
   - fixed queue
1. aof
   - 记录最近追加的 id(aof_update_id), 初始 0
   - 根据 base ss 的 id，过滤转发过来的请求, 如果请求 id>aof_update_id+1, 则从请求缓存中读取
1. 发送从节点
   - 记录最近发送的 id， 初始为请求 id （部分复制）
   - 过滤转发过来的请求, 如果请求 转发的 id 大于 base, 则从请求缓存中读取
