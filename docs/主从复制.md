# 主从复制

## 目标

1. 减少复制过程中的内存开销
   - 不缓冲 aof
   - 同一时间的脏页少
   - 边序列化边传输
1. 减少复制过程中的 io 开销
   - 不进行磁盘快照
   - 传递的数据格式小
1. 速度快
   - 不进行磁盘快照
   - 不缓冲 aof

## 主要流程

1. 通知节点 B（未来的从节点）把节点 A 设置为主节点

   - 在配置文件中指定，启动的时候就去设置
   - 发送命令动态切换（这个暂时不做，需要控制权限）

1. B 发送命令给 A：`synccmd` 开始同步命令

   - 主节点转发
   - 从节点接收
     - 先用个 channel 接收
     - 读 channel 的时候 判断一下是否需要阻塞 等 snapshot
     - B 每 10s 发个 `synccmdping`, A 返回特殊 message，channel 中丢弃即可

1. B 发送命令给 A：`syncsnapshot` 开始同步快照

   - A 迭代发完
     - 启动一个子进程进行同步
     - 发 Option\<u16>的 bincode
     - 发 dict 的 bincode
   - B 迭代接收

1. 这样两种同步方式就可以在主节点端解耦了

## 其他

1. 只能有单个从节点保证 io
1. 从节点只读

## 待解决的问题

1. 不支持部分重同步
