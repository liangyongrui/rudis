# 主从复制

## 主要流程

1. 建立连接

   - 通知节点 B（未来的从节点）把节点 A 设置为主节点
     - 在配置文件中指定，启动的时候就去设置
     - 动态切换, 发送一个命令指定，销毁当前 db，重新启动 (这种暂时不考虑)
   - B 发送命令给 A：sync 开始同步
   - 建一个 unbound channel， 把转发的消息都存进去
   - 让 A 做一次 snapshot，做完后通知主从 task

1. 发送数据

   - 发送 snapshot 数据，一个一个 slot 发, 格式: [长度 u64([u8;8]), data]
   - 当获取到的长度为 0 时，代表 snapshot 发送结束，下次发送的数据就是一条条的转发数据了

1. 保持连接

   - 每隔 10s 从节点向主节点发送 PING 命令

## 难点

- [x] 如何加锁，保证修改不重复，不遗漏
- [x] 如何减少锁定的时间
